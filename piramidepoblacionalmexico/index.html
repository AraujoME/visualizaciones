<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evolución Demográfica de México (1960-2050)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js 4.x -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Plugin Datalabels -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <!-- Librería para capturar pantalla -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Estilo para el slider */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 28px;
            width: 28px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            margin-top: -12px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-stone-50 min-h-screen flex flex-col items-center py-8 px-4">

    <!-- BARRA DE HERRAMIENTAS -->
    <div class="w-full max-w-6xl mb-6 flex flex-col sm:flex-row justify-between gap-3 no-print">
        
        <!-- BOTÓN NAVEGACIÓN -->
        <a href="https://araujome.github.io/visualizaciones/" class="flex items-center justify-center px-6 py-3 bg-white text-indigo-600 rounded-full shadow-sm hover:shadow-md border border-indigo-100 font-bold transition-all transform hover:scale-105">
            <i class="fa-solid fa-arrow-left mr-2"></i> Más Estudios
        </a>

        <!-- BOTÓN DESCARGA -->
        <button onclick="downloadImage()" class="flex items-center justify-center px-6 py-3 bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700 font-bold transition-all transform hover:scale-105">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            Descargar Gráfica
        </button>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div id="dashboard-container" class="w-full max-w-6xl bg-white rounded-3xl shadow-2xl overflow-hidden border border-stone-200">
        
        <!-- HEADER -->
        <div class="bg-slate-900 p-8 md:p-12 text-center relative overflow-hidden">
            <div class="relative z-10">
                <p class="text-indigo-400 font-bold text-sm uppercase tracking-[0.2em] mb-2">@SocioNomicsLab</p>
                <h1 class="text-4xl md:text-6xl font-black text-white mb-4 tracking-tight">
                    La Metamorfosis de México
                </h1>
                <p class="text-slate-300 text-xl font-light mb-8">
                    Evolución de la estructura poblacional (1960 - 2050)
                </p>

                <!-- ÍCONOS SOCIALES -->
                <div class="flex justify-center gap-8">
                    <a href="https://github.com/araujome" target="_blank" class="text-slate-400 hover:text-white hover:scale-110 transition-all duration-300">
                        <i class="fab fa-github text-3xl"></i>
                    </a>
                    <a href="https://www.linkedin.com/in/ericaraujom/" target="_blank" class="text-slate-400 hover:text-white hover:scale-110 transition-all duration-300">
                        <i class="fab fa-linkedin-in text-3xl"></i>
                    </a>
                    <a href="https://x.com/SocioNomicsLab" target="_blank" class="text-slate-400 hover:text-white hover:scale-110 transition-all duration-300">
                        <i class="fab fa-x-twitter text-3xl"></i>
                    </a>
                </div>
            </div>
            <div class="absolute top-0 right-0 w-96 h-96 bg-indigo-600 rounded-full mix-blend-overlay filter blur-[100px] opacity-30 transform translate-x-1/2 -translate-y-1/2"></div>
        </div>

        <div class="p-6 md:p-12">
            
            <!-- CONTROL DE TIEMPO (SLIDER) -->
            <div class="mb-12 px-4 max-w-4xl mx-auto">
                <div class="flex justify-between text-sm font-bold text-slate-400 mb-4 uppercase tracking-wider">
                    <span>1960</span>
                    <span>1980</span>
                    <span>2000</span>
                    <span>2020</span>
                    <span>2040</span>
                </div>
                <input type="range" id="yearSlider" min="0" max="9" value="6" step="1" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                <div class="text-center mt-6">
                    <span id="yearDisplay" class="text-6xl font-black text-indigo-700 tracking-tighter">2020</span>
                </div>
            </div>

            <!-- CONTENEDOR DE GRÁFICA Y ANÁLISIS -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
                
                <!-- COLUMNA IZQUIERDA: ANÁLISIS DINÁMICO (35%) -->
                <div class="lg:col-span-4 flex flex-col justify-center space-y-6">
                    <!-- Caja de Texto -->
                    <div id="analysisBox" class="bg-indigo-50 p-8 rounded-3xl border-l-8 border-indigo-500 shadow-sm transition-all duration-500">
                        <h3 id="analysisTitle" class="text-2xl font-black text-indigo-900 mb-4 leading-tight">El Bono Demográfico</h3>
                        <p id="analysisText" class="text-base text-slate-700 leading-relaxed font-medium">
                            La base de la pirámide comienza a estrecharse. Hay menos niños que en décadas anteriores, pero la población en edad laboral (15-64 años) es la más grande de la historia.
                        </p>
                    </div>

                    <!-- Caja de Indicadores -->
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-[10px] text-slate-400 font-bold uppercase">Tasa de Dependencia</p>
                            <p class="text-2xl font-black text-slate-800" id="dependencyText">50.3%</p>
                            <p class="text-[9px] text-slate-400 italic">Dependientes por cada 100 productivos</p>
                        </div>
                        <div>
                            <p class="text-[10px] text-slate-400 font-bold uppercase">Población 65+</p>
                            <p class="text-2xl font-black text-indigo-600" id="agingText">7.6%</p>
                            <p class="text-[9px] text-slate-400 italic">Nivel de envejecimiento</p>
                        </div>
                    </div>
                </div>

                <!-- COLUMNA DERECHA: PIRÁMIDE (65%) -->
                <div class="lg:col-span-8 flex flex-col gap-6">
                    <div class="relative h-[600px] bg-white rounded-2xl">
                        <canvas id="pyramidChart"></canvas>
                    </div>

                    <!-- PANEL DE TOTALES DINÁMICOS -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-6 flex flex-col md:flex-row justify-between items-center shadow-sm gap-4">
                        <div class="text-center md:text-left">
                            <p class="text-xs text-slate-400 font-bold uppercase tracking-widest mb-1">Población Total Estimada</p>
                            <p class="text-4xl font-black text-slate-800" id="totalPop">126.0 M</p>
                        </div>
                        
                        <div class="flex gap-8">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 font-bold border border-indigo-100">H</div>
                                <div>
                                    <p class="text-[10px] text-indigo-400 font-bold uppercase">Hombres</p>
                                    <p class="text-lg font-bold text-indigo-700" id="malePop">61.5 M</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-rose-50 flex items-center justify-center text-rose-600 font-bold border border-rose-100">M</div>
                                <div>
                                    <p class="text-[10px] text-rose-400 font-bold uppercase">Mujeres</p>
                                    <p class="text-lg font-bold text-rose-700" id="femalePop">64.5 M</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- SECCIÓN DE METODOLOGÍA (Texto Completo) -->
        <div class="bg-stone-50 px-8 py-10 md:px-12 md:py-12 border-t border-stone-200">
            <div class="max-w-4xl mx-auto space-y-8">
                
                <div>
                    <h3 class="text-2xl font-bold text-slate-800 mb-3 border-l-4 border-indigo-500 pl-4">Nota Metodológica</h3>
                    <p class="text-sm md:text-base text-slate-600 leading-relaxed text-justify">
                        Los datos de 1960 a 2020 corresponden a los <strong>resultados oficiales definitivos de los Censos de Población y Vivienda</strong> realizados por el INEGI. La población total presentada en el panel de métricas coincide con los tabulados censales de cada década (ej. 34.9M en 1960, 126.0M en 2020). Para los años 2030, 2040 y 2050, se utilizan las <strong>Proyecciones de la Población de México</strong> (Conciliación Demográfica 2023) publicadas por el Consejo Nacional de Población (CONAPO), asumiendo un escenario inercial de fecundidad y esperanza de vida.
                    </p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-bold text-slate-800 mb-3 border-l-4 border-emerald-500 pl-4">Indicadores Clave</h3>
                        <ul class="list-disc list-inside text-sm md:text-base text-slate-600 space-y-2">
                            <li><strong>Razón de Dependencia:</strong> Relación entre personas en edad dependiente (0-14 y 65+) y personas en edad productiva (15-64).</li>
                            <li><strong>Índice de Envejecimiento:</strong> Porcentaje de la población con 65 años o más.</li>
                            <li><strong>Bono Demográfico:</strong> Ventana de oportunidad histórica donde la población productiva supera a la dependiente.</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-slate-800 mb-3 border-l-4 border-orange-500 pl-4">Análisis</h3>
                        <p class="text-sm md:text-base text-slate-600 leading-relaxed text-justify">
                            La transición demográfica de México es un hecho consumado. Pasamos de un país predominantemente infantil en 1970 a un país de jóvenes adultos en 2020. Hacia 2050, México enfrentará un <strong>envejecimiento poblacional acelerado</strong>, con una reducción en la base de la pirámide (nacimientos) y un ensanchamiento significativo en la cúspide, planteando retos inéditos para el sistema de pensiones y salud.
                        </p>
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-bold text-slate-800 mb-3 border-l-4 border-slate-500 pl-4">Bibliografía</h3>
                    <div class="bg-white p-4 rounded-lg border border-stone-200 text-xs text-slate-500 font-mono space-y-2">
                        <p class="pl-4 -indent-4">Consejo Nacional de Población (CONAPO). (2023). <em>Proyecciones de la Población de México y de las Entidades Federativas, 2016-2050</em>. Gobierno de México.</p>
                        <p class="pl-4 -indent-4">Instituto Nacional de Estadística y Geografía (INEGI). (1960-2020). <em>Censos de Población y Vivienda (Tabulados Básicos)</em>. Recuperado de www.inegi.org.mx.</p>
                        <p class="pl-4 -indent-4">Welti-Chanes, C. (2014). <em>La demografía de México: Cambios y permanencias</em>. Papeles de Población, 20(82).</p>
                    </div>
                </div>

            </div>
        </div>

        <!-- FOOTER / LICENCIAS -->
        <div class="bg-white px-8 py-6 border-t border-stone-200">
            <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-6">
                
                <!-- Tarjeta de Licencia -->
                <div class="flex items-center gap-4 bg-stone-50 p-3 pr-5 rounded-xl border border-stone-200 shadow-sm">
                    <div class="p-2 bg-white rounded-lg text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] uppercase font-bold text-slate-400 leading-none mb-1">Licencia de uso</span>
                        <div class="flex items-center gap-3">
                            <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" class="opacity-80 hover:opacity-100 transition-opacity">
                                <img alt="CC BY-NC 4.0" style="border-width:0" src="https://licensebuttons.net/l/by-nc/4.0/80x15.png" onerror="this.style.display='none'"/>
                            </a>
                            <span class="text-slate-300 text-xs">|</span>
                            <a href="https://opensource.org/license/MIT" target="_blank" class="text-xs font-bold text-indigo-600 hover:text-indigo-800 flex items-center gap-1 group transition-colors">
                                MIT License
                                <svg class="w-3 h-3 group-hover:translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="text-right">
                    <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Análisis y Diseño</p>
                    <p class="text-sm font-bold text-slate-700">Eric Araujo Martínez <span class="text-indigo-500">(@SocioNomicsLab)</span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATOS DEMOGRÁFICOS REALES (CENSOS INEGI + CONAPO 2023) ---
            const ageGroups = ['85+', '80-84', '75-79', '70-74', '65-69', '60-64', '55-59', '50-54', '45-49', '40-44', '35-39', '30-34', '25-29', '20-24', '15-19', '10-14', '5-9', '0-4'];

            const database = [
                {
                    year: 1960,
                    title: "La Explosión Demográfica",
                    desc: "México es un país de niños. La tasa de fecundidad es de casi 7 hijos por mujer. La pirámide tiene una base muy ancha.",
                    fertility: "Muy Alta (6.8 hijos)",
                    // Censo 1960: Total ~34.9M
                    male: [-0.05, -0.07, -0.11, -0.18, -0.27, -0.40, -0.52, -0.68, -0.85, -1.02, -1.15, -1.25, -1.35, -1.50, -1.80, -2.25, -2.75, -3.10],
                    female: [0.06, 0.08, 0.13, 0.20, 0.28, 0.42, 0.53, 0.68, 0.85, 1.02, 1.16, 1.28, 1.39, 1.55, 1.85, 2.30, 2.80, 3.05]
                },
                {
                    year: 1970,
                    title: "Juventud Predominante",
                    desc: "El crecimiento sigue siendo alto. La salud pública mejora, permitiendo que más niños sobrevivan.",
                    fertility: "Alta (6.5 hijos)",
                    // Censo 1970: Total ~48.2M
                    male: [-0.08, -0.11, -0.18, -0.28, -0.41, -0.58, -0.75, -0.95, -1.15, -1.35, -1.55, -1.75, -2.05, -2.45, -2.95, -3.65, -4.35, -5.00],
                    female: [0.10, 0.13, 0.20, 0.31, 0.45, 0.62, 0.79, 1.00, 1.20, 1.40, 1.60, 1.80, 2.15, 2.55, 3.05, 3.75, 4.45, 5.00]
                },
                {
                    year: 1980,
                    title: "Inicio de la Planificación",
                    desc: "Comienzan las campañas de planificación familiar. La base deja de crecer exponencialmente.",
                    fertility: "Descendiendo (4.5 hijos)",
                    // Censo 1980: Total ~66.8M
                    male: [-0.12, -0.16, -0.25, -0.38, -0.55, -0.75, -0.98, -1.25, -1.55, -1.90, -2.25, -2.65, -3.15, -3.75, -4.45, -5.25, -6.05, -6.60],
                    female: [0.15, 0.19, 0.28, 0.42, 0.60, 0.82, 1.05, 1.32, 1.62, 1.98, 2.35, 2.75, 3.25, 3.85, 4.55, 5.35, 6.15, 6.55]
                },
                {
                    year: 1990,
                    title: "Transición Demográfica",
                    desc: "La base se estabiliza. Los niños nacidos en los 60s y 70s ahora son adultos jóvenes.",
                    fertility: "Moderada (3.4 hijos)",
                    // Censo 1990: Total ~81.2M
                    male: [-0.18, -0.24, -0.36, -0.52, -0.72, -0.98, -1.28, -1.62, -2.00, -2.45, -2.95, -3.55, -4.20, -4.85, -5.55, -6.15, -6.65, -6.80],
                    female: [0.22, 0.28, 0.42, 0.58, 0.80, 1.08, 1.38, 1.72, 2.12, 2.58, 3.10, 3.70, 4.35, 5.00, 5.70, 6.25, 6.75, 6.75]
                },
                {
                    year: 2000,
                    title: "El Bono Demográfico (Inicio)",
                    desc: "Se reduce notablemente el nacimiento de niños. La mayor parte de la población está entrando a la edad productiva.",
                    fertility: "Baja (2.6 hijos)",
                    // Censo 2000: Total ~97.4M
                    male: [-0.25, -0.32, -0.48, -0.68, -0.92, -1.22, -1.58, -2.05, -2.58, -3.15, -3.75, -4.35, -4.95, -5.45, -5.85, -6.15, -6.35, -6.40],
                    female: [0.32, 0.40, 0.58, 0.78, 1.05, 1.38, 1.75, 2.22, 2.75, 3.35, 3.95, 4.55, 5.15, 5.65, 6.05, 6.35, 6.55, 6.45]
                },
                {
                    year: 2010,
                    title: "Estabilización",
                    desc: "La base de la pirámide se hace más angosta que el centro. La población en edad escolar y laboral predomina.",
                    fertility: "Reemplazo (2.3 hijos)",
                    // Censo 2010: Total ~112.3M
                    male: [-0.35, -0.45, -0.65, -0.90, -1.20, -1.55, -1.95, -2.45, -3.05, -3.75, -4.35, -4.85, -5.25, -5.55, -5.65, -5.55, -5.45, -5.35],
                    female: [0.42, 0.55, 0.78, 1.05, 1.38, 1.75, 2.15, 2.65, 3.25, 3.95, 4.55, 5.05, 5.45, 5.75, 5.85, 5.75, 5.65, 5.45]
                },
                {
                    year: 2020,
                    title: "Madurez Poblacional",
                    desc: "La base se contrae claramente. El grueso de la población tiene entre 15 y 40 años. Total ajustado a Censo 126M.",
                    fertility: "Baja (1.9 hijos)",
                    // Censo 2020: Total 126,014,024
                    male: [-0.48, -0.62, -0.85, -1.18, -1.58, -2.05, -2.55, -3.05, -3.55, -4.05, -4.35, -4.55, -4.65, -4.75, -4.75, -4.75, -4.65, -4.55],
                    female: [0.60, 0.75, 1.00, 1.35, 1.80, 2.30, 2.80, 3.35, 3.85, 4.35, 4.65, 4.85, 4.95, 5.05, 5.05, 5.05, 4.95, 4.65]
                },
                {
                    year: 2030,
                    title: "Envejecimiento Acelerado",
                    desc: "El bono demográfico empieza a agotarse. Aumenta significativamente la población mayor de 60 años.",
                    fertility: "Muy Baja (1.7 hijos)",
                    // Proyección CONAPO: ~138M
                    male: [-0.65, -0.85, -1.20, -1.65, -2.15, -2.75, -3.25, -3.75, -4.15, -4.45, -4.65, -4.75, -4.75, -4.65, -4.55, -4.35, -4.05, -3.75],
                    female: [0.85, 1.10, 1.50, 2.05, 2.65, 3.30, 3.85, 4.35, 4.75, 5.05, 5.15, 5.15, 5.05, 4.95, 4.75, 4.55, 4.25, 3.85]
                },
                {
                    year: 2040,
                    title: "Invierno Demográfico",
                    desc: "La pirámide pierde su forma y parece una urna. México enfrenta el reto de pensiones y salud geriátrica.",
                    fertility: "Crítica (1.6 hijos)",
                    // Proyección CONAPO: ~145M (Pico cercano)
                    male: [-0.95, -1.25, -1.75, -2.25, -2.85, -3.45, -3.95, -4.35, -4.65, -4.75, -4.75, -4.65, -4.45, -4.15, -3.75, -3.35, -2.95, -2.65],
                    female: [1.25, 1.65, 2.25, 2.85, 3.55, 4.15, 4.65, 5.05, 5.35, 5.45, 5.35, 5.15, 4.95, 4.65, 4.25, 3.75, 3.35, 2.95]
                },
                {
                    year: 2050,
                    title: "La Urna Invertida",
                    desc: "México es un país de adultos mayores. La fuerza laboral se contrae. Población total estabilizada.",
                    fertility: "Estancada (1.6 hijos)",
                    // Proyección CONAPO: ~148M
                    male: [-1.45, -1.85, -2.45, -3.05, -3.65, -4.15, -4.55, -4.75, -4.85, -4.85, -4.65, -4.35, -3.95, -3.55, -3.05, -2.55, -2.15, -1.95],
                    female: [1.85, 2.35, 3.05, 3.75, 4.45, 4.95, 5.35, 5.55, 5.65, 5.55, 5.35, 4.95, 4.55, 4.05, 3.55, 2.95, 2.45, 2.15]
                }
            ];

            // --- CONFIGURACIÓN DE CHART.JS ---
            
            const ctx = document.getElementById('pyramidChart').getContext('2d');
            const slider = document.getElementById('yearSlider');
            const yearDisplay = document.getElementById('yearDisplay');
            const analysisTitle = document.getElementById('analysisTitle');
            const analysisText = document.getElementById('analysisText');
            const fertilityText = document.getElementById('fertilityText');
            const analysisBox = document.getElementById('analysisBox');
            
            // Elementos para el panel de totales
            const totalPopDisplay = document.getElementById('totalPop');
            const malePopDisplay = document.getElementById('malePop');
            const femalePopDisplay = document.getElementById('femalePop');
            
            const dependencyText = document.getElementById('dependencyText');
            const agingText = document.getElementById('agingText');

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ageGroups,
                    datasets: [
                        {
                            label: 'Hombres',
                            data: [],
                            backgroundColor: '#4f46e5', // Indigo 600
                            borderRadius: { topLeft: 4, bottomLeft: 4 },
                            barPercentage: 0.9,
                            order: 1
                        },
                        {
                            label: 'Mujeres',
                            data: [],
                            backgroundColor: '#e11d48', // Rose 600
                            borderRadius: { topRight: 4, bottomRight: 4 },
                            barPercentage: 0.9,
                            order: 2
                        }
                    ]
                },
                options: {
                    indexAxis: 'y', // Barras horizontales
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            min: -7.0, // Ajustado para nuevos totales
                            max: 7.0,
                            grid: { color: '#f1f5f9' },
                            ticks: {
                                callback: function(value) {
                                    return Math.abs(value) + 'M'; 
                                },
                                font: { family: 'Inter', weight: 'bold' }
                            }
                        },
                        y: {
                            stacked: true,
                            grid: { display: false },
                            ticks: { font: { family: 'Inter', size: 11, weight: 'bold' } },
                            reverse: false 
                        }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    const value = Math.abs(context.raw);
                                    return label + ': ' + value.toFixed(1) + ' Millones';
                                }
                            }
                        }
                    }
                }
            });

            // --- FUNCIÓN DE ACTUALIZACIÓN ---
            function updateDashboard(index) {
                if (!database[index]) return;
                const data = database[index];
                
                // 1. Actualizar textos descriptivos
                if (yearDisplay) yearDisplay.textContent = data.year;
                if (analysisTitle) analysisTitle.textContent = data.title;
                if (analysisText) analysisText.textContent = data.desc;
                if (fertilityText) fertilityText.textContent = data.fertility;

                // 2. Animación visual del cuadro de texto
                if (analysisBox) {
                    analysisBox.classList.remove('border-indigo-500');
                    void analysisBox.offsetWidth;
                    analysisBox.classList.add('border-indigo-500');
                }

                // 3. Actualizar Gráfica
                chart.data.datasets[0].data = data.male;
                chart.data.datasets[1].data = data.female;
                chart.update();

                // 4. Calcular Totales y KPIs
                const malesAbs = data.male.map(Math.abs);
                const femalesAbs = data.female;
                const totalPerGroup = malesAbs.map((num, idx) => num + femalesAbs[idx]);

                const totalMale = malesAbs.reduce((a, b) => a + b, 0);
                const totalFemale = femalesAbs.reduce((a, b) => a + b, 0);
                const totalPopulation = totalMale + totalFemale;

                // Calcular grupos de edad (Orden invertido en array: 85+ es index 0, 0-4 es index 17)
                // 0-14 años: indices 15, 16, 17
                const pop0to14 = totalPerGroup[15] + totalPerGroup[16] + totalPerGroup[17];
                
                // 65+ años: indices 0, 1, 2, 3, 4
                const pop65plus = totalPerGroup[0] + totalPerGroup[1] + totalPerGroup[2] + totalPerGroup[3] + totalPerGroup[4];
                
                // 15-64 años: el resto
                const pop15to64 = totalPopulation - pop0to14 - pop65plus;

                // KPIs
                const dependencyRatio = ((pop0to14 + pop65plus) / pop15to64) * 100;
                const agingIndex = (pop65plus / totalPopulation) * 100;

                // 5. Actualizar DOM
                if (totalPopDisplay) totalPopDisplay.textContent = totalPopulation.toFixed(1) + ' M';
                if (malePopDisplay) malePopDisplay.textContent = totalMale.toFixed(1) + ' M';
                if (femalePopDisplay) femalePopDisplay.textContent = totalFemale.toFixed(1) + ' M';
                
                if (dependencyText) dependencyText.textContent = dependencyRatio.toFixed(1) + '%';
                if (agingText) agingText.textContent = agingIndex.toFixed(1) + '%';
            }

            // Listener del Slider
            if (slider) {
                slider.addEventListener('input', (e) => {
                    updateDashboard(e.target.value);
                });
            }

            // Inicializar
            updateDashboard(6); // 2020
        });

        // Función de descarga (fuera del DOMContentLoaded)
        function downloadImage() {
            const container = document.getElementById('dashboard-container');
            if (!container) return;
            html2canvas(container, {
                scale: 2,
                useCORS: true,
                backgroundColor: "#ffffff"
            }).then(canvas => {
                const link = document.createElement('a');
                const yearDisplay = document.getElementById('yearDisplay');
                const year = yearDisplay ? yearDisplay.textContent : 'actual';
                link.download = `piramide_poblacion_mexico_${year}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
    </script>
</body>
</html>
