import React, { useState, useEffect, useRef } from 'react';
import { 
  TrendingUp, 
  Download, 
  ShieldAlert, 
  Loader2, 
  Zap, 
  Globe, 
  Activity,
  Fingerprint,
  Scale,
  ArrowRightLeft,
  DollarSign,
  User,
  CheckCircle,
  Copyright,
  Calendar
} from 'lucide-react';

/**
 * Evolución del PIB Per Cápita (PPA) - Auditoría Final
 * Formato: 16:9 Premium
 * Altura de Gráfica: 500px
 * Elaboración: Eric Araujo Martínez para @SocioNomicsLab
 * Nota: Incluye aclaración sobre cierre de datos 2024
 */

const DATA_HISTORICA = [
  { year: 2010, usa: 48500, rus: 20500, mex: 15200, chi: 9300 },
  { year: 2012, usa: 51600, rus: 23300, mex: 16700, chi: 11200 },
  { year: 2014, usa: 55000, rus: 24800, mex: 17600, chi: 13200 },
  { year: 2016, usa: 58000, rus: 24100, mex: 18600, chi: 15300 },
  { year: 2018, usa: 62800, rus: 28700, mex: 19900, chi: 17600 },
  { year: 2020, usa: 63500, rus: 29900, mex: 19300, chi: 17200 },
  { year: 2022, usa: 76200, rus: 36500, mex: 22800, chi: 21400 },
  { year: 2024, usa: 85400, rus: 38300, mex: 25900, chi: 25000 }
];

const LegendItem = ({ color, label, dash }) => (
  <div className="flex items-center gap-2">
    <div className={`w-8 md:w-12 h-1.5 md:h-2 ${color} ${dash ? 'border-t-2 md:border-t-4 border-dashed border-white' : 'rounded-full'}`}></div>
    <span className="text-[10px] md:text-[12px] font-black text-slate-500 uppercase tracking-widest leading-none">{label}</span>
  </div>
);

export default function App() {
  const [isExporting, setIsExporting] = useState(false);
  const [libLoaded, setLibLoaded] = useState(false);
  const exportRef = useRef(null);

  useEffect(() => {
    const script = document.createElement('script');
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
    script.async = true;
    script.onload = () => setLibLoaded(true);
    document.body.appendChild(script);
  }, []);

  const handleDownload = async () => {
    if (!libLoaded || !window.html2canvas) return;
    setIsExporting(true);
    setTimeout(async () => {
      try {
        const element = exportRef.current;
        const canvas = await window.html2canvas(element, {
          backgroundColor: '#ffffff',
          scale: 3, 
          logging: false,
          useCORS: true,
        });
        const dataUrl = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = `SocioNomicsLab_PIB_Audit_2024_Final.png`;
        link.href = dataUrl;
        link.click();
      } catch (err) { console.error(err); } 
      finally { setIsExporting(false); }
    }, 150);
  };

  const maxVal = 95000;
  const width = 850;
  const height = 500; 

  const getPoints = (key) => {
    return DATA_HISTORICA.map((d, i) => {
      const x = (i / (DATA_HISTORICA.length - 1)) * width;
      const y = height - (d[key] / maxVal) * height;
      return `${x},${y}`;
    }).join(' ');
  };

  return (
    <div className="min-h-screen bg-slate-100 p-2 md:p-8 font-sans text-slate-900 flex flex-col items-center justify-center gap-6">
      
      {/* AREA DE EXPORTACIÓN */}
      <div 
        ref={exportRef}
        className="w-full max-w-[1000px] bg-white border border-slate-200 shadow-2xl flex flex-col overflow-hidden"
        style={{ borderRadius: '2.5rem' }}
      >
        {/* Header Lab Style */}
        <div className="bg-slate-950 px-6 md:px-12 py-10 text-white flex flex-col md:flex-row justify-between items-center gap-6 relative overflow-hidden shrink-0 border-b-8 border-indigo-600">
          <div className="absolute top-0 right-0 w-80 h-80 bg-indigo-600 rounded-full -mr-40 -mt-40 blur-[100px] opacity-20"></div>
          <div className="relative z-10 flex items-center gap-4 md:gap-6">
            <div className="p-4 md:p-5 bg-indigo-600 rounded-[1.2rem] md:rounded-[1.5rem] shadow-xl shadow-indigo-900/40 ring-4 ring-indigo-500/20">
              <TrendingUp size={32} className="md:w-10 md:h-10" />
            </div>
            <div className="space-y-1 text-center md:text-left">
              <p className="text-[9px] md:text-[11px] font-black uppercase tracking-[0.4em] md:tracking-[0.5em] text-indigo-400 leading-none">Global Economic Audit • Intelligence Report</p>
              <h1 className="text-2xl md:text-4xl font-black tracking-tighter leading-none uppercase italic text-white">
                Evolución del <span className="text-indigo-500 underline decoration-white underline-offset-8">PIB Per Cápita</span>
              </h1>
              <p className="text-[9px] md:text-[10px] text-slate-400 font-bold uppercase tracking-widest pt-1 italic">Bienestar Real • Métrica PPA Internacional</p>
            </div>
          </div>
          <div className="relative z-10 text-center md:text-right">
             <p className="text-[10px] md:text-[12px] font-black text-slate-500 uppercase tracking-widest mb-1 italic leading-none">2010 - 2024</p>
             <p className="text-2xl md:text-4xl font-black text-white tracking-tighter italic leading-none uppercase underline decoration-indigo-500 decoration-4">@SocioNomicsLab</p>
          </div>
        </div>

        <div className="flex-grow flex flex-col p-6 md:p-12 gap-8 md:gap-12 bg-white">
          {/* SECCIÓN SUPERIOR: Gráfica */}
          <div className="w-full space-y-4">
            <div className="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
               <div className="flex flex-wrap justify-center md:justify-start gap-4 md:gap-8">
                 <LegendItem color="bg-slate-900" label="Estados Unidos" />
                 <LegendItem color="bg-indigo-500" label="Rusia (Auditado)" dash />
                 <LegendItem color="bg-emerald-500" label="México" />
                 <LegendItem color="bg-rose-500" label="China" />
               </div>
               <div className="flex items-center gap-2 text-indigo-600 font-black text-[9px] md:text-[10px] uppercase tracking-widest bg-indigo-50 px-4 py-2 rounded-xl italic">
                  <Activity size={14} /> Dinámica 2024: $ Int (PPA)
               </div>
            </div>

            <div className="relative h-[350px] md:h-[500px] pt-4 px-2">
               <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full overflow-visible" preserveAspectRatio="xMidYMid meet">
                  {/* Grid Lines */}
                  {[0, 0.25, 0.5, 0.75, 1].map((v, i) => (
                    <line key={i} x1="0" y1={height * v} x2={width} y2={height * v} stroke="#f1f5f9" strokeWidth="2" />
                  ))}
                  
                  {/* Años */}
                  {DATA_HISTORICA.map((d, i) => (
                    <g key={i}>
                      <text x={(i / (DATA_HISTORICA.length - 1)) * width} y={height + 35} className="text-[14px] font-black fill-slate-400 italic" textAnchor="middle">{d.year}</text>
                      <line x1={(i / (DATA_HISTORICA.length - 1)) * width} y1="0" x2={(i / (DATA_HISTORICA.length - 1)) * width} y2={height} stroke="#f8fafc" strokeWidth="1" />
                    </g>
                  ))}
                  
                  {/* Líneas */}
                  <polyline points={getPoints('usa')} fill="none" stroke="#0f172a" strokeWidth="6" strokeLinecap="round" strokeLinejoin="round" />
                  <polyline points={getPoints('rus')} fill="none" stroke="#6366f1" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round" strokeDasharray="10 5" />
                  <polyline points={getPoints('mex')} fill="none" stroke="#10b981" strokeWidth="6" strokeLinecap="round" strokeLinejoin="round" />
                  <polyline points={getPoints('chi')} fill="none" stroke="#f43f5e" strokeWidth="6" strokeLinecap="round" strokeLinejoin="round" />
                  
                  {/* Etiquetas Finales */}
                  <g className="text-[14px] font-black italic tabular-nums">
                    <text x={width + 12} y={height - (DATA_HISTORICA[7].usa / maxVal) * height + 5} className="fill-slate-950">$85,400</text>
                    <text x={width + 12} y={height - (DATA_HISTORICA[7].rus / maxVal) * height + 5} className="fill-indigo-600">$38,300</text>
                    <text x={width + 12} y={height - (DATA_HISTORICA[7].mex / maxVal) * height - 5} className="fill-emerald-600">$25,900</text>
                    <text x={width + 12} y={height - (DATA_HISTORICA[7].chi / maxVal) * height + 15} className="fill-rose-600">$25,000</text>
                  </g>
               </svg>
            </div>
          </div>

          {/* SECCIÓN INFERIOR: Nota y Bloques de Licencia */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 items-stretch pt-4">
             <div className="bg-slate-50 p-6 md:p-8 rounded-[2rem] border border-slate-100 flex flex-col sm:flex-row items-start gap-6 shadow-inner relative">
                <div className="bg-indigo-600 text-white p-4 rounded-3xl shrink-0">
                   <Scale size={28} />
                </div>
                <div className="space-y-3">
                   <h3 className="text-[11px] font-black uppercase tracking-[0.3em] text-slate-900 leading-none italic">Nota Metodológica: El Efecto PPA</h3>
                   <p className="text-[12px] text-slate-600 leading-relaxed font-bold italic">
                     La **Paridad del Poder Adquisitivo (PPA)** ajusta el ingreso al costo de vida local, permitiendo medir el bienestar real sin la distorsión del tipo de cambio.
                   </p>
                   {/* NOTA DE CIERRE 2024 SOLICITADA */}
                   <div className="flex items-center gap-2 pt-1 border-t border-slate-200">
                      <Calendar size={14} className="text-indigo-500" />
                      <p className="text-[10px] text-slate-400 font-black uppercase tracking-widest leading-tight">
                         Cierre 2024: Último ejercicio con cifras consolidadas y proyecciones auditadas (FMI/BM).
                      </p>
                   </div>
                </div>
             </div>

             <div className="bg-emerald-50 p-6 md:p-8 rounded-[2rem] border border-emerald-100 flex flex-col justify-between shadow-inner relative overflow-hidden">
                <div className="absolute top-0 right-0 p-4 opacity-10">
                   <ArrowRightLeft size={80} className="text-emerald-900" />
                </div>
                <div className="relative z-10 space-y-4">
                   <h3 className="text-[11px] font-black uppercase tracking-[0.3em] text-emerald-900 leading-none italic">México: Nominal vs PPA (2024)</h3>
                   <div className="flex items-center justify-between border-b border-emerald-200/50 pb-3">
                      <div className="flex items-center gap-2">
                         <DollarSign size={16} className="text-slate-400" />
                         <span className="text-[10px] font-black text-slate-500 uppercase leading-none">PIB Nominal (Mercado)</span>
                      </div>
                      <span className="text-xl font-black text-slate-400 italic tracking-tighter">$13,900</span>
                   </div>
                   <div className="flex items-center justify-between pt-1">
                      <div className="flex items-center gap-2">
                         <Zap size={16} className="text-emerald-600" />
                         <span className="text-[10px] font-black text-emerald-900 uppercase leading-none font-black italic tracking-widest">PIB Real (PPA)</span>
                      </div>
                      <span className="text-3xl font-black text-emerald-600 italic tracking-tighter">$25,900</span>
                   </div>
                </div>
             </div>
          </div>

          {/* LICENCIAS */}
          <div className="mt-4 pt-8 border-t border-slate-100">
             <div className="flex flex-col md:flex-row items-center justify-between gap-8">
                <div className="flex flex-col md:flex-row items-center gap-6">
                   <div className="flex gap-1.5 shrink-0">
                      <div className="w-10 h-10 rounded bg-slate-950 flex items-center justify-center text-white text-[11px] font-black">CC</div>
                      <div className="w-10 h-10 rounded bg-slate-950 flex items-center justify-center text-white"><User size={16} /></div>
                      <div className="w-10 h-10 rounded bg-slate-950 flex items-center justify-center text-white text-[11px] font-black font-serif italic">nc</div>
                      <div className="w-10 h-10 rounded bg-slate-950 flex items-center justify-center text-white text-[11px] font-black font-serif italic">sa</div>
                   </div>
                   <div className="space-y-1 text-center md:text-left">
                      <p className="text-[11px] font-black text-slate-900 uppercase tracking-widest leading-none italic">Creative Commons Attribution-NonCommercial 4.0</p>
                      <p className="text-[12px] font-bold text-slate-400 italic leading-none">Uso libre para fines educativos citando a @SocioNomicsLab</p>
                   </div>
                </div>
                <div className="flex items-center gap-4">
                   <div className="bg-slate-50 border border-slate-200 px-5 py-3 rounded-2xl flex items-center gap-3">
                      <div className="p-2 bg-indigo-600 rounded-lg text-white"><CheckCircle size={16} /></div>
                      <div className="flex flex-col leading-none text-left">
                        <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Audit Protocol</span>
                        <span className="text-[12px] font-black text-slate-900 uppercase tracking-tighter">MIT Data Verified</span>
                      </div>
                   </div>
                </div>
             </div>
          </div>
        </div>

        {/* Footer */}
        <div className="bg-slate-50 border-t border-slate-100 px-6 md:px-12 py-6 flex flex-col md:flex-row justify-between items-center gap-6 shrink-0">
           <div className="flex items-center gap-8">
             <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2 italic">
               <Globe size={14} className="text-indigo-600" /> Fuente: FMI (WEO 2024) e Informe SocioNomics
             </span>
             <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2 italic">
               <Fingerprint size={14} className="text-indigo-600" /> Auditoría de Datos Verificada
             </span>
           </div>
           <div className="text-[11px] font-black text-indigo-600 uppercase tracking-widest italic tracking-tighter">Análisis por Eric Araujo Martínez • 2025</div>
        </div>
      </div>

      {/* Control Panel */}
      <div className="w-full max-w-[1000px] flex justify-between items-center px-4 pb-8">
        <p className="text-[11px] text-slate-500 font-black uppercase tracking-widest leading-none italic">
           @SocioNomicsLab • Intelligence for Impact
        </p>
        <button 
          onClick={handleDownload}
          disabled={isExporting || !libLoaded}
          className={`
            py-4 px-12 rounded-2xl font-black text-sm uppercase tracking-widest flex items-center justify-center gap-3 transition-all
            ${isExporting ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-slate-950 text-white hover:bg-indigo-700 shadow-xl active:scale-95'}
          `}
        >
          {isExporting ? (
            <><Loader2 className="animate-spin" size={20} /> Generando...</>
          ) : (
            <><Download size={20} /> Descargar Reporte Final (PNG)</>
          )}
        </button>
      </div>

    </div>
  );
}
